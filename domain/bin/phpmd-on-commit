#!/usr/bin/env bash

set -e

echo "phpmd starts"

CURRENT_DIRECTORY=`pwd`
BIN_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

DOMAIN_DIRECTORY="$BIN_DIR/.."


cd $DOMAIN_DIRECTORY;
PHPMD="vendor/bin/phpmd"

HAS_PHPMD=false

if [ -x "$PHPMD" ]; then
    HAS_PHPMD=true
fi

if $HAS_PHPMD; then
    git --git-dir ../.git --work-tree .. diff --name-only --diff-filter=ACMR HEAD | grep -e 'domain/.*\.php$' | cut -c 12- | while read line; do
    	echo ${line};
        ${PHPMD} src/${line} xml cleancode,codesize,controversial,design,naming,unusedcode;
    done
else
    echo ""
    echo "Please install phpmd dependence"
    echo "  cd domain && composer install"
    echo ""
	cd $CURRENT_DIRECTORY;
    exit 1
fi

cd $CURRENT_DIRECTORY;

echo "phpmd ends"
